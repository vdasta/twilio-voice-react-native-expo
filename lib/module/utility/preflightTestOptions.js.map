{"version":3,"names":["InvalidArgumentError","AudioCodecType","IceTransportPolicy","validateIceTransportPolicy","iceTransportPolicy","Object","values","includes","status","error","validateIceServer","iceServer","hasUsername","hasPassword","hasServerUrl","username","password","serverUrl","validateIceServers","iceServers","Array","isArray","validation","validateAudioCodec","audioCodec","type","maxAverageBitrate","validateAudioCodecs","audioCodecs","validatePreflightOptions","preflightTestOptions","preferredAudioCodecs"],"sources":["preflightTestOptions.ts"],"sourcesContent":["import { InvalidArgumentError } from '../error/InvalidArgumentError';\nimport type { PreflightTest } from '../PreflightTest';\nimport { AudioCodec, AudioCodecType } from '../type/AudioCodec';\nimport { IceTransportPolicy, IceServer } from '../type/Ice';\n\nexport type InvalidOptions = {\n  status: 'error';\n  error: InvalidArgumentError;\n};\n\nexport type ValidOptions<T> = { status: 'ok' } & T;\n\nexport type OptionValidation<T> = InvalidOptions | ValidOptions<T>;\n\nfunction validateIceTransportPolicy(\n  iceTransportPolicy: IceTransportPolicy\n): OptionValidation<{ iceTransportPolicy: IceTransportPolicy }> {\n  if (\n    typeof iceTransportPolicy !== 'string' ||\n    !Object.values(IceTransportPolicy).includes(iceTransportPolicy)\n  ) {\n    return {\n      status: 'error',\n      error: new InvalidArgumentError(\n        'If \"iceTransportPolicy\" is present, it must be a string of value ' +\n          '\"relay\" or \"all\".'\n      ),\n    };\n  }\n\n  return { status: 'ok', iceTransportPolicy };\n}\n\nfunction validateIceServer(\n  iceServer: IceServer\n): OptionValidation<{ iceServer: IceServer }> {\n  if (typeof iceServer !== 'object' || iceServer === null) {\n    return {\n      status: 'error',\n      error: new InvalidArgumentError('\"iceServer\" must be a non-null object.'),\n    };\n  }\n\n  const hasUsername = 'username' in iceServer;\n  const hasPassword = 'password' in iceServer;\n  const hasServerUrl = 'serverUrl' in iceServer;\n\n  if (hasUsername) {\n    const { username } = iceServer;\n    if (typeof username !== 'string') {\n      return {\n        status: 'error',\n        error: new InvalidArgumentError(\n          'If \"username\" is present in \"iceServer\", it must be a string.'\n        ),\n      };\n    }\n  }\n\n  if (hasPassword) {\n    const { password } = iceServer;\n    if (typeof password !== 'string') {\n      return {\n        status: 'error',\n        error: new InvalidArgumentError(\n          'If \"password\" is present in \"iceServer\", it must be a string.'\n        ),\n      };\n    }\n  }\n\n  if (hasServerUrl) {\n    const { serverUrl } = iceServer;\n    if (typeof serverUrl !== 'string') {\n      return {\n        status: 'error',\n        error: new InvalidArgumentError(\n          'If \"serverUrl\" is present in \"iceServer\", it must be a string.'\n        ),\n      };\n    }\n  }\n\n  if (hasUsername && hasPassword && hasServerUrl) {\n    return {\n      status: 'ok',\n      iceServer,\n    };\n  }\n\n  if (!hasUsername && !hasPassword && hasServerUrl) {\n    return {\n      status: 'ok',\n      iceServer,\n    };\n  }\n\n  return {\n    status: 'error',\n    error: new InvalidArgumentError(\n      'Ice server must have type: { serverUrl: string } | { username: ' +\n        'string; password: string; serverUrl: string }'\n    ),\n  };\n}\n\nfunction validateIceServers(\n  iceServers: IceServer[]\n): OptionValidation<{ iceServers: IceServer[] }> {\n  if (!Array.isArray(iceServers)) {\n    return {\n      status: 'error',\n      error: new InvalidArgumentError(\n        'If \"iceServers\" are present, it must be an array of valid IceServer ' +\n          'objects.'\n      ),\n    };\n  }\n\n  for (const iceServer of iceServers) {\n    const validation = validateIceServer(iceServer);\n    if (validation.status === 'error') {\n      return validation;\n    }\n  }\n\n  return {\n    status: 'ok',\n    iceServers,\n  };\n}\n\nfunction validateAudioCodec(\n  audioCodec: AudioCodec\n): OptionValidation<{ audioCodec: AudioCodec }> {\n  if (typeof audioCodec !== 'object') {\n    return {\n      status: 'error',\n      error: new InvalidArgumentError(\n        'If \"audioCodec\" is present, it must be an object.'\n      ),\n    };\n  }\n\n  if ('type' in audioCodec) {\n    const { type } = audioCodec;\n    if (\n      typeof type !== 'string' ||\n      !Object.values(AudioCodecType).includes(type)\n    ) {\n      return {\n        status: 'error',\n        error: new InvalidArgumentError(\n          'The type of \"audioCodec.type\" must be a string valued one of ' +\n            '[\"opus\", \"pcmu\"].'\n        ),\n      };\n    }\n  }\n\n  if ('maxAverageBitrate' in audioCodec) {\n    const { maxAverageBitrate } = audioCodec;\n    if (typeof maxAverageBitrate !== 'number') {\n      return {\n        status: 'error',\n        error: new InvalidArgumentError(\n          'The type of \"audioCodec.maxAverageBitrate\" must be a number.'\n        ),\n      };\n    }\n  }\n\n  return {\n    status: 'ok',\n    audioCodec,\n  };\n}\n\nfunction validateAudioCodecs(\n  audioCodecs: AudioCodec[]\n): OptionValidation<{ audioCodecs: AudioCodec[] }> {\n  if (!Array.isArray(audioCodecs)) {\n    return {\n      status: 'error',\n      error: new InvalidArgumentError(\n        'If \"preferredAudioCodecs\" is present, it must be an array of valid ' +\n          '\"audioCodec\" objects.'\n      ),\n    };\n  }\n\n  for (const audioCodec of audioCodecs) {\n    const validation = validateAudioCodec(audioCodec);\n    if (validation.status === 'error') {\n      return validation;\n    }\n  }\n\n  return {\n    status: 'ok',\n    audioCodecs,\n  };\n}\n\nexport function validatePreflightOptions(\n  preflightTestOptions: PreflightTest.Options\n): OptionValidation<{ preflightTestOptions: PreflightTest.Options }> {\n  if ('iceTransportPolicy' in preflightTestOptions) {\n    const validation = validateIceTransportPolicy(\n      preflightTestOptions.iceTransportPolicy!\n    );\n    if (validation.status === 'error') {\n      return validation;\n    }\n  }\n\n  if ('iceServers' in preflightTestOptions) {\n    const validation = validateIceServers(preflightTestOptions.iceServers!);\n    if (validation.status === 'error') {\n      return validation;\n    }\n  }\n\n  if ('preferredAudioCodecs' in preflightTestOptions) {\n    const validation = validateAudioCodecs(\n      preflightTestOptions.preferredAudioCodecs!\n    );\n    if (validation.status === 'error') {\n      return validation;\n    }\n  }\n\n  return {\n    status: 'ok',\n    preflightTestOptions,\n  };\n}\n"],"mappings":"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","ignoreList":[]}